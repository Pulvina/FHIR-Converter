{
    "resourceType": "Patient",
    "id": "{{ msg.id | default: msg.patientId | to_json_string | generate_uuid }}",
    "text": {
        "status": "generated",
        "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">Patient with prioritized contact methods</div>"
    },
    "active": true,
    {% comment -%} Basic name handling {% endcomment -%}
    "name": [
        {
            "use": "official",
            {% if msg.name -%}
            "text": "{{ msg.name }}"
            {% elsif msg.firstName and msg.lastName -%}
            "family": "{{ msg.lastName }}",
            "given": ["{{ msg.firstName }}"]
            {% elsif msg.patientName -%}
            "text": "{{ msg.patientName }}"
            {% endif -%}
        }
    ],
    {% comment -%} Prioritized contact methods {% endcomment -%}
    "telecom": [
        {% comment -%} Primary preferred contact {% endcomment -%}
        {% if msg.primaryPhone or msg.preferredPhone -%}
        {
            "system": "phone",
            "value": "{{ msg.primaryPhone | default: msg.preferredPhone }}",
            "use": "{{ msg.primaryPhoneType | default: 'home' | downcase }}",
            "rank": 1,
            "extension": [
                {
                    "url": "http://hl7.org/fhir/StructureDefinition/contactpoint-comment",
                    "valueString": "Primary contact method"
                }
            ]
        },
        {% endif -%}
        {% comment -%} Secondary contact {% endcomment -%}
        {% if msg.secondaryPhone or msg.alternatePhone -%}
        {
            "system": "phone",
            "value": "{{ msg.secondaryPhone | default: msg.alternatePhone }}",
            "use": "{{ msg.secondaryPhoneType | default: 'mobile' | downcase }}",
            "rank": 2,
            "extension": [
                {
                    "url": "http://hl7.org/fhir/StructureDefinition/contactpoint-comment",
                    "valueString": "Secondary contact method"
                }
            ]
        },
        {% endif -%}
        {% comment -%} Work contact {% endcomment -%}
        {% if msg.workPhone -%}
        {
            "system": "phone",
            "value": "{{ msg.workPhone }}",
            "use": "work",
            "rank": 3,
            "period": {
                "extension": [
                    {
                        "url": "http://hl7.org/fhir/StructureDefinition/contactpoint-comment",
                        "valueString": "Business hours only"
                    }
                ]
            }
        },
        {% endif -%}
        {% comment -%} Primary email {% endcomment -%}
        {% if msg.primaryEmail or msg.preferredEmail -%}
        {
            "system": "email",
            "value": "{{ msg.primaryEmail | default: msg.preferredEmail }}",
            "use": "home",
            "rank": 1
        },
        {% endif -%}
        {% comment -%} Work email {% endcomment -%}
        {% if msg.workEmail -%}
        {
            "system": "email",
            "value": "{{ msg.workEmail }}",
            "use": "work",
            "rank": 2
        },
        {% endif -%}
        {% comment -%} Emergency contact method {% endcomment -%}
        {% if msg.emergencyPhone -%}
        {
            "system": "phone",
            "value": "{{ msg.emergencyPhone }}",
            "use": "mobile",
            "rank": 1,
            "extension": [
                {
                    "url": "http://hl7.org/fhir/StructureDefinition/contactpoint-comment",
                    "valueString": "Emergency use only"
                }
            ]
        }
        {% endif -%}
    ],
    {% if msg.birthDate or msg.dob -%}
    "birthDate": "{{ msg.birthDate | default: msg.dob }}",
    {% endif -%}
    "managingOrganization": {
        "reference": "Organization/priority-contacts",
        "display": "Priority Contact Healthcare"
    }
}