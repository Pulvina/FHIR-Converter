{
    "resourceType": "Patient",
    "id": "{{ msg.id | default: msg.patientId | to_json_string | generate_uuid }}",
    "text": {
        "status": "generated",
        "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">Patient with international address</div>"
    },
    "active": true,
    {% comment -%} Basic name handling {% endcomment -%}
    "name": [
        {
            "use": "official",
            {% if msg.name -%}
            "text": "{{ msg.name }}"
            {% elsif msg.firstName and msg.lastName -%}
            "family": "{{ msg.lastName }}",
            "given": ["{{ msg.firstName }}"]
            {% elsif msg.patientName -%}
            "text": "{{ msg.patientName }}"
            {% endif -%}
        }
    ],
    {% comment -%} International address handling {% endcomment -%}
    "address": [
        {
            "use": "{{ msg.addressType | default: 'home' | downcase }}",
            {% comment -%} Handle various international address line formats {% endcomment -%}
            {% if msg.street or msg.streetAddress or msg.addressLine1 or msg.buildingNumber or msg.buildingName -%}
            "line": [
                {% if msg.buildingName -%}
                "{{ msg.buildingName }}"{% if msg.buildingNumber or msg.street or msg.streetAddress %},{% endif %}
                {% endif -%}
                {% if msg.buildingNumber -%}
                "{{ msg.buildingNumber }}"{% if msg.street or msg.streetAddress %} {% endif %}
                {% endif -%}
                {% if msg.street or msg.streetAddress or msg.addressLine1 -%}
                "{{ msg.street | default: msg.streetAddress | default: msg.addressLine1 }}"
                {% endif -%}
                {% if msg.addressLine2 or msg.apartment or msg.unit -%}
                ,"{{ msg.addressLine2 | default: msg.apartment | default: msg.unit }}"
                {% endif -%}
                {% if msg.addressLine3 or msg.district -%}
                ,"{{ msg.addressLine3 | default: msg.district }}"
                {% endif -%}
            ],
            {% endif -%}
            {% if msg.city or msg.town or msg.locality -%}
            "city": "{{ msg.city | default: msg.town | default: msg.locality }}",
            {% endif -%}
            {% comment -%} Handle district/region/province variations {% endcomment -%}
            {% assign region = msg.state | default: msg.province | default: msg.region | default: msg.county | default: msg.prefecture -%}
            {% if region -%}
            "state": "{{ region }}",
            {% endif -%}
            {% comment -%} Handle postal code variations {% endcomment -%}
            {% assign postal = msg.zip | default: msg.zipCode | default: msg.postalCode | default: msg.postcode -%}
            {% if postal -%}
            "postalCode": "{{ postal }}",
            {% endif -%}
            {% if msg.country or msg.countryCode -%}
            "country": "{{ msg.country | default: msg.countryCode }}",
            {% endif -%}
            {% comment -%} International extensions {% endcomment -%}
            "extension": [
                {% if msg.countryCode and msg.country -%}
                {
                    "url": "http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-country",
                    "valueString": "{{ msg.countryCode }}"
                },
                {% endif -%}
                {% if msg.timeZone -%}
                {
                    "url": "http://hl7.org/fhir/StructureDefinition/patient-timezone",
                    "valueString": "{{ msg.timeZone }}"
                }
                {% endif -%}
            ]
        }
    ],
    {% if msg.birthDate or msg.dob -%}
    "birthDate": "{{ msg.birthDate | default: msg.dob }}",
    {% endif -%}
    "managingOrganization": {
        "reference": "Organization/international",
        "display": "International Healthcare Network"
    }
}