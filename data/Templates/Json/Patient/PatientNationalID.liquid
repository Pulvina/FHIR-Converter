{
    "resourceType": "Patient",
    "id": "{{ msg.nationalId | default: msg.nationalID | default: msg.nin | to_json_string | generate_uuid }}",
    "text": {
        "status": "generated",
        "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\">Patient National ID: {{ msg.nationalId | default: msg.nationalID | default: msg.nin }}{% if msg.country %}, Country: {{ msg.country }}{% endif %}</div>"
    },
    "identifier": [
        {
            "use": "official",
            "type": {
                "coding": [
                    {
                        "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                        "code": "NI",
                        "display": "National unique individual identifier"
                    }
                ]
            },
            {% comment -%} Different countries have different national ID systems {% endcomment -%}
            {% if msg.country == "UK" or msg.country == "GB" -%}
            "system": "https://fhir.nhs.uk/Id/nhs-number",
            {% elsif msg.country == "US" -%}
            "system": "http://hl7.org/fhir/sid/us-ssn",
            {% elsif msg.country == "CA" -%}
            "system": "https://fhir.infoway-inforoute.ca/NamingSystem/ca-hi",
            {% else -%}
            "system": "urn:oid:2.16.840.1.113883.4.1",
            {% endif -%}
            "value": "{{ msg.nationalId | default: msg.nationalID | default: msg.nin | default: msg.national_id | default: msg.nhsNumber }}"
        }
    ],
    "active": true,
    {% if msg.name or msg.fullName or msg.firstName or msg.lastName -%}
    "name": [
        {
            "use": "official",
            {% if msg.fullName or msg.name -%}
            "text": "{{ msg.fullName | default: msg.name }}",
            {% endif -%}
            {% if msg.firstName or msg.givenName -%}
            "given": ["{{ msg.firstName | default: msg.givenName }}"],
            {% endif -%}
            {% if msg.lastName or msg.familyName -%}
            "family": "{{ msg.lastName | default: msg.familyName }}"
            {% endif -%}
        }
    ],
    {% endif -%}
    {% if msg.dateOfBirth or msg.dob or msg.birthDate -%}
    "birthDate": "{{ msg.dateOfBirth | default: msg.dob | default: msg.birthDate }}",
    {% endif -%}
    {% if msg.gender or msg.sex -%}
    "gender": {% assign genderVal = msg.gender | default: msg.sex | downcase -%}
        {% if genderVal == 'male' or genderVal == 'm' -%}"male"
        {% elsif genderVal == 'female' or genderVal == 'f' -%}"female"
        {% else -%}"unknown"
        {% endif -%},
    {% endif -%}
    "managingOrganization": {
        "reference": "Organization/national-registry",
        "display": "National Health Registry"
    }
}